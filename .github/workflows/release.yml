name: Build & Release

on:
  push:
    branches: [dev, release]
  workflow_dispatch:

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant permissions
        run: chmod +x gradlew

      - name: Generate version
        run: |
          # åŸºç¡€ç‰ˆæœ¬
          BASE_VERSION="0.1.0"

          # æ ¹æ®åˆ†æ”¯ç”Ÿæˆç‰ˆæœ¬å·
          if [[ "${{ github.ref_name }}" == "release" ]]; then
            VERSION_NAME="${BASE_VERSION}"
            IS_PRERELEASE=false
          else
            VERSION_NAME="${BASE_VERSION}-beta.${{ github.run_number }}"
            IS_PRERELEASE=true
          fi

          # ç”Ÿæˆç‰ˆæœ¬ä»£ç 
          VERSION_CODE="$(date +%Y%m%d)$(printf "%03d" ${{ github.run_number }})"

          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV

          echo "ðŸ“± Building: ${VERSION_NAME} (${VERSION_CODE})"

      - name: Setup signing for release builds
        if: env.IS_PRERELEASE == 'false'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks

      - name: Build Release APK (Debug)
        if: env.IS_PRERELEASE == 'true'
        run: ./gradlew assembleRelease
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}

      - name: Build Release APK (Signed)
        if: env.IS_PRERELEASE == 'false'
        run: ./gradlew assembleRelease
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts

          # å…ˆåˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„ APK æ–‡ä»¶
          echo "=== æŸ¥æ‰¾ APK æ–‡ä»¶ ==="
          find app/build -name "*.apk" -type f -exec echo "Found: {}" \;

          # å°è¯• debug ç›®å½•
          if [ -d "app/build/outputs/apk/debug" ]; then
            echo "=== ä½¿ç”¨ debug ç›®å½• ==="
            ls -la app/build/outputs/apk/debug/

            cp app/build/outputs/apk/debug/app-arm64-v8a-debug.apk \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
            cp app/build/outputs/apk/debug/app-armeabi-v7a-debug.apk \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
            cp app/build/outputs/apk/debug/app-universal-debug.apk \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
          fi

          # å°è¯• release ç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -d "app/build/outputs/apk/release" ]; then
            echo "=== ä½¿ç”¨ release ç›®å½• ==="
            ls -la app/build/outputs/apk/release/

            # å¤„ç†å¯èƒ½çš„ unsigned æ–‡ä»¶
            if [ -f "app/build/outputs/apk/release/app-arm64-v8a-release.apk" ]; then
              cp app/build/outputs/apk/release/app-arm64-v8a-release.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
            elif [ -f "app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk" ]; then
              cp app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
            fi

            if [ -f "app/build/outputs/apk/release/app-armeabi-v7a-release.apk" ]; then
              cp app/build/outputs/apk/release/app-armeabi-v7a-release.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
            elif [ -f "app/build/outputs/apk/release/app-armeabi-v7a-release-unsigned.apk" ]; then
              cp app/build/outputs/apk/release/app-armeabi-v7a-release-unsigned.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
            fi

            if [ -f "app/build/outputs/apk/release/app-universal-release.apk" ]; then
              cp app/build/outputs/apk/release/app-universal-release.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
            elif [ -f "app/build/outputs/apk/release/app-universal-release-unsigned.apk" ]; then
              cp app/build/outputs/apk/release/app-universal-release-unsigned.apk \
                 artifacts/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
            fi
          fi

          # æ£€æŸ¥ artifacts ç›®å½•
          echo "=== artifacts ç›®å½•å†…å®¹ ==="
          ls -la artifacts/

          # ç”Ÿæˆæ ¡éªŒå’Œ
          cd artifacts
          if [ -n "$(ls *.apk 2>/dev/null)" ]; then
            sha256sum *.apk > checksums.txt
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• APK æ–‡ä»¶"
            exit 1
          fi

      - name: Generate Release Notes
        run: |
          cat > release-notes.md << EOF
          # Lumi Assistant ${{ env.VERSION_NAME }}

          ## ðŸ“± ä¸‹è½½

          é€‰æ‹©é€‚åˆä½ è®¾å¤‡çš„ APKï¼š

          - **Universal** - é€šç”¨ç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          - **ARM64** - 64ä½è®¾å¤‡
          - **ARMv7** - 32ä½è®¾å¤‡

          **æž„å»ºä¿¡æ¯ï¼š**
          - ç‰ˆæœ¬: ${{ env.VERSION_NAME }}
          - æž„å»ºå·: ${{ env.VERSION_CODE }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æäº¤: ${{ github.sha }}

          ---
          *è‡ªåŠ¨æž„å»ºäºŽ $(date +'%Y-%m-%d %H:%M:%S')*
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.IS_PRERELEASE == 'true' && format('beta-{0}', env.VERSION_NAME) || format('v{0}', env.VERSION_NAME) }}
          name: Lumi Assistant ${{ env.VERSION_NAME }}
          body_path: release-notes.md
          files: artifacts/*
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: rm -f release-key.jks
