name: Build & Release

on:
  push:
    branches: [dev, release]
  workflow_dispatch:

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant permissions
        run: chmod +x gradlew

      - name: Generate version
        run: |
          # åŸºç¡€ç‰ˆæœ¬
          BASE_VERSION="0.1.0"

          # æ ¹æ®åˆ†æ”¯ç”Ÿæˆç‰ˆæœ¬å·
          if [[ "${{ github.ref_name }}" == "release" ]]; then
            VERSION_NAME="${BASE_VERSION}"
            IS_PRERELEASE=false
          else
            VERSION_NAME="${BASE_VERSION}-beta.${{ github.run_number }}"
            IS_PRERELEASE=true
          fi

          # ç”Ÿæˆç‰ˆæœ¬ä»£ç 
          VERSION_CODE="$(date +%Y%m%d)$(printf "%03d" ${{ github.run_number }})"

          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV

          echo "ðŸ“± Building: ${VERSION_NAME} (${VERSION_CODE})"

      - name: Setup signing for release builds
        if: env.IS_PRERELEASE == 'false'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks

      - name: Build Release APK (Debug)
        if: env.IS_PRERELEASE == 'true'
        run: ./gradlew assembleRelease
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}

      - name: Build Release APK (Signed)
        if: env.IS_PRERELEASE == 'false'
        run: ./gradlew assembleRelease
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts

          # æŸ¥æ‰¾å®žé™…ç”Ÿæˆçš„ APK æ–‡ä»¶
          APK_DIR=$(find app/build/outputs/apk -name "*.apk" | head -1 | xargs dirname | sort | uniq | tail -1)
          echo "APK ç›®å½•: ${APK_DIR}"
          ls -la "${APK_DIR}/"

          # å¤åˆ¶ APK æ–‡ä»¶
          if [ -f "${APK_DIR}/app-arm64-v8a-release.apk" ]; then
            cp "${APK_DIR}/app-arm64-v8a-release.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
          elif [ -f "${APK_DIR}/app-arm64-v8a-debug.apk" ]; then
            cp "${APK_DIR}/app-arm64-v8a-debug.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
          fi

          if [ -f "${APK_DIR}/app-armeabi-v7a-release.apk" ]; then
            cp "${APK_DIR}/app-armeabi-v7a-release.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
          elif [ -f "${APK_DIR}/app-armeabi-v7a-debug.apk" ]; then
            cp "${APK_DIR}/app-armeabi-v7a-debug.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
          fi

          if [ -f "${APK_DIR}/app-universal-release.apk" ]; then
            cp "${APK_DIR}/app-universal-release.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
          elif [ -f "${APK_DIR}/app-universal-debug.apk" ]; then
            cp "${APK_DIR}/app-universal-debug.apk" \
               artifacts/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
          fi

          # ç”Ÿæˆæ ¡éªŒå’Œ
          cd artifacts
          sha256sum *.apk > checksums.txt

      - name: Generate Release Notes
        run: |
          cat > release-notes.md << EOF
          # Lumi Assistant ${{ env.VERSION_NAME }}

          ## ðŸ“± ä¸‹è½½

          é€‰æ‹©é€‚åˆä½ è®¾å¤‡çš„ APKï¼š

          - **Universal** - é€šç”¨ç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          - **ARM64** - 64ä½è®¾å¤‡
          - **ARMv7** - 32ä½è®¾å¤‡

          **æž„å»ºä¿¡æ¯ï¼š**
          - ç‰ˆæœ¬: ${{ env.VERSION_NAME }}
          - æž„å»ºå·: ${{ env.VERSION_CODE }}
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æäº¤: ${{ github.sha }}

          ---
          *è‡ªåŠ¨æž„å»ºäºŽ $(date +'%Y-%m-%d %H:%M:%S')*
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.IS_PRERELEASE == 'true' && format('beta-{0}', env.VERSION_NAME) || format('v{0}', env.VERSION_NAME) }}
          name: Lumi Assistant ${{ env.VERSION_NAME }}
          body_path: release-notes.md
          files: artifacts/*
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: rm -f release-key.jks
