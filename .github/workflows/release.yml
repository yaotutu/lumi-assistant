name: Release Build

on:
  push:
    branches:
      - dev       # è§¦å‘æ¡ä»¶: æŽ¨é€åˆ° dev åˆ†æ”¯ï¼ˆå‘å¸ƒæµ‹è¯•ç‰ˆï¼‰
      - release   # è§¦å‘æ¡ä»¶: æŽ¨é€åˆ° release åˆ†æ”¯ï¼ˆå‘å¸ƒæ­£å¼ç‰ˆï¼‰
    tags:
      - 'v*'     # ä¹Ÿæ”¯æŒ tag è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (å¦‚: 0.1.0)'
        required: true
        type: string
      environment:
        description: 'çŽ¯å¢ƒç±»åž‹'
        required: true
        type: choice
        options:
          - beta
          - production

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: æŽˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        run: |
          chmod +x .github/scripts/version-generator.sh
          .github/scripts/version-generator.sh

          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION_NAME=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          fi

      - name: ç”Ÿæˆ Release Notes
        run: |
          chmod +x .github/scripts/release-generator.sh
          VERSION="${{ env.VERSION_NAME }}" \
          BUILD_NUMBER="${{ env.VERSION_CODE }}" \
          COMMIT_SHA="${{ github.sha }}" \
          COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')" \
          COMMIT_AUTHOR="$(git log -1 --pretty=format:'%an')" \
          COMMIT_DATE="$(git log -1 --pretty=format:'%ci')" \
          BRANCH="${{ github.ref_name }}" \
          GITHUB_REPOSITORY="${{ github.repository }}" \
          .github/scripts/release-generator.sh

      - name: è§£ç ç­¾åå¯†é’¥
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks

      - name: æž„å»º Release APK
        run: ./gradlew assembleRelease --stacktrace
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

      - name: é‡å‘½å APK æ–‡ä»¶
        run: |
          mkdir -p release-output

          # å¤åˆ¶å¹¶é‡å‘½åå„æž¶æž„ APK
          cp app/build/outputs/apk/release/app-arm64-v8a-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk

          cp app/build/outputs/apk/release/app-armeabi-v7a-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk

          cp app/build/outputs/apk/release/app-universal-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk

      - name: ç”Ÿæˆ APK æ ¡éªŒå’Œ
        run: |
          cd release-output
          sha256sum *.apk > checksums.txt
          cat checksums.txt

      - name: åˆ¤æ–­å‘å¸ƒç±»åž‹
        id: release_type
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }} (Beta)" >> $GITHUB_OUTPUT
            echo "TAG_NAME=beta-${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "release" ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=v${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }} (Test)" >> $GITHUB_OUTPUT
            echo "TAG_NAME=test-${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_type.outputs.TAG_NAME }}
          name: ${{ steps.release_type.outputs.RELEASE_NAME }}
          body_path: release_notes.md
          files: |
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
            release-output/checksums.txt
          draft: false
          prerelease: ${{ steps.release_type.outputs.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†ç­¾åæ–‡ä»¶
        if: always()
        run: rm -f release-key.jks

      - name: å‘å¸ƒæ€»ç»“
        run: |
          echo "### ðŸš€ å‘å¸ƒå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`${{ env.VERSION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version Code: \`${{ env.VERSION_CODE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release é“¾æŽ¥:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— [${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
