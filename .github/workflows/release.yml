name: Release Build

on:
  push:
    branches:
      - dev       # è§¦å‘æ¡ä»¶: æŽ¨é€åˆ° dev åˆ†æ”¯ï¼ˆå‘å¸ƒæµ‹è¯•ç‰ˆï¼‰
      - release   # è§¦å‘æ¡ä»¶: æŽ¨é€åˆ° release åˆ†æ”¯ï¼ˆå‘å¸ƒæ­£å¼ç‰ˆï¼‰
    tags:
      - 'v*'     # ä¹Ÿæ”¯æŒ tag è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (å¦‚: 1.0.0)'
        required: true
        type: string
      environment:
        description: 'çŽ¯å¢ƒç±»åž‹'
        required: true
        type: choice
        options:
          - beta
          - production

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: æŽˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        run: |
          chmod +x .github/scripts/version-generator.sh
          .github/scripts/version-generator.sh

          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "VERSION_NAME=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          fi

      - name: è§£ç ç­¾åå¯†é’¥
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks

      - name: æž„å»º Release APK
        run: ./gradlew assembleRelease --stacktrace
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

      - name: é‡å‘½å APK æ–‡ä»¶
        run: |
          mkdir -p release-output

          # å¤åˆ¶å¹¶é‡å‘½åå„æž¶æž„ APK
          cp app/build/outputs/apk/release/app-arm64-v8a-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk

          cp app/build/outputs/apk/release/app-armeabi-v7a-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk

          cp app/build/outputs/apk/release/app-universal-release.apk \
             release-output/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk

      - name: ç”Ÿæˆ APK æ ¡éªŒå’Œ
        run: |
          cd release-output
          sha256sum *.apk > checksums.txt
          cat checksums.txt

      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # åˆ¤æ–­å‘å¸ƒç±»åž‹æ ‡ç­¾
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            RELEASE_TAG="ðŸ§ª æµ‹è¯•ç‰ˆ (Beta)"
            RELEASE_WARNING="âš ï¸ **è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½ä¸ç¨³å®šï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ï¼**"
          elif [[ "${{ github.ref_name }}" == "release" ]]; then
            RELEASE_TAG="âœ… æ­£å¼ç‰ˆ (Production)"
            RELEASE_WARNING=""
          else
            RELEASE_TAG="ðŸ“¦ é¢„è§ˆç‰ˆ"
            RELEASE_WARNING="âš ï¸ **è¿™æ˜¯éžæ­£å¼ç‰ˆæœ¬ï¼Œè¯·è°¨æ…Žä½¿ç”¨ï¼**"
          fi

          cat > release-notes.md << 'EOF'
          ## ðŸ“± Lumi Assistant ${{ env.VERSION_NAME }}

          ### ðŸ·ï¸ ç‰ˆæœ¬ç±»åž‹
          ${RELEASE_TAG}

          ${RELEASE_WARNING}

          ### ðŸ“¦ ä¸‹è½½ APK

          æ ¹æ®ä½ çš„è®¾å¤‡é€‰æ‹©å¯¹åº”æž¶æž„ä¸‹è½½ï¼ˆä¸ç¡®å®šå°±é€‰ Universalï¼‰ï¼š

          | æ–‡ä»¶ | æž¶æž„ | é€‚ç”¨è®¾å¤‡ | å¤§å° |
          |------|------|---------|------|
          | `lumi-assistant-${{ env.VERSION_NAME }}-universal.apk` | é€šç”¨ç‰ˆ | **æ‰€æœ‰ ARM è®¾å¤‡ï¼ˆæŽ¨èï¼‰** | ~è¾ƒå¤§ |
          | `lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk` | 64ä½ | 2019å¹´åŽçš„çŽ°ä»£æ‰‹æœº | ~è¾ƒå° |
          | `lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk` | 32ä½ | è€æ—§è®¾å¤‡ | ~è¾ƒå° |

          > ðŸ’¡ **é€‰æ‹©å»ºè®®**:
          > - ä¸ç¡®å®šï¼Ÿä¸‹è½½ **universal** ç‰ˆæœ¬ï¼ˆå…¼å®¹æ‰€æœ‰è®¾å¤‡ï¼‰
          > - æƒ³è¦æ›´å°ä½“ç§¯ï¼Ÿæ ¹æ®è®¾å¤‡æž¶æž„é€‰æ‹©å¯¹åº”ç‰ˆæœ¬

          ### ðŸ”– ç‰ˆæœ¬ä¿¡æ¯
          - **Version Name**: ${{ env.VERSION_NAME }}
          - **Version Code**: ${{ env.VERSION_CODE }}
          - **Build Date**: $(date +"%Y-%m-%d %H:%M:%S")
          - **Commit**: ${{ github.sha }}
          - **æ”¯æŒæž¶æž„**: ARM64-v8a, ARMv7

          ### ðŸ“ æ›´æ–°å†…å®¹
          $(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD 2>/dev/null || echo "- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ")

          ### ðŸ” å®‰å…¨æ ¡éªŒ
          ä¸‹è½½åŽå¯éªŒè¯ SHA256 æ ¡éªŒå’Œ:
          ```
          $(cat release-output/checksums.txt)
          ```

          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          - **æœ€ä½Žç‰ˆæœ¬**: Android 7.0 (API 24)
          - **æŽ¨èç‰ˆæœ¬**: Android 12+ (æ”¯æŒ Material You åŠ¨æ€é…è‰²)
          - **æ”¯æŒæž¶æž„**: ARM è®¾å¤‡ï¼ˆä¸æ”¯æŒ x86 æ¨¡æ‹Ÿå™¨ï¼‰

          ---
          **æž„å»ºçŽ¯å¢ƒ**: GitHub Actions
          **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: åˆ¤æ–­å‘å¸ƒç±»åž‹
        id: release_type
        run: |
          if [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }} (Beta)" >> $GITHUB_OUTPUT
            echo "TAG_NAME=beta-${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "release" ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=v${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "RELEASE_NAME=Lumi Assistant ${{ env.VERSION_NAME }} (Test)" >> $GITHUB_OUTPUT
            echo "TAG_NAME=test-${{ env.VERSION_NAME }}" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_type.outputs.TAG_NAME }}
          name: ${{ steps.release_type.outputs.RELEASE_NAME }}
          body_path: release-notes.md
          files: |
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-universal.apk
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-arm64-v8a.apk
            release-output/lumi-assistant-${{ env.VERSION_NAME }}-armeabi-v7a.apk
            release-output/checksums.txt
          draft: false
          prerelease: ${{ steps.release_type.outputs.IS_PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†ç­¾åæ–‡ä»¶
        if: always()
        run: rm -f release-key.jks

      - name: å‘å¸ƒæ€»ç»“
        run: |
          echo "### ðŸš€ å‘å¸ƒå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`${{ env.VERSION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version Code: \`${{ env.VERSION_CODE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release é“¾æŽ¥:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— [${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
