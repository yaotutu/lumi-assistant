name: Android Build

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽç‰ˆæœ¬å·ç”Ÿæˆ

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: æŽˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        run: |
          chmod +x .github/scripts/version-generator.sh
          .github/scripts/version-generator.sh

      - name: æž„å»º Debug APK
        run: ./gradlew assembleDebug --stacktrace
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}

      - name: è§£ç ç­¾åå¯†é’¥
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release-key.jks
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}

      - name: æž„å»º Release APK
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: ./gradlew assembleRelease --stacktrace
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}
          VERSION_NAME: ${{ env.VERSION_NAME }}
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

      - name: ä¸Šä¼  Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: lumi-assistant-debug-${{ env.VERSION_NAME }}
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: ä¸Šä¼  Release APK (æ‰€æœ‰æž¶æž„)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: lumi-assistant-release-${{ env.VERSION_NAME }}
          path: |
            app/build/outputs/apk/release/app-arm64-v8a-release.apk
            app/build/outputs/apk/release/app-armeabi-v7a-release.apk
            app/build/outputs/apk/release/app-universal-release.apk
          retention-days: 90

      - name: æ¸…ç†ç­¾åæ–‡ä»¶
        if: always()
        run: rm -f release-key.jks

      - name: æž„å»ºæ€»ç»“
        run: |
          echo "### ðŸ“¦ æž„å»ºå®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- Version Name: \`${{ env.VERSION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version Code: \`${{ env.VERSION_CODE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ env.COMMIT_SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æž„å»ºäº§ç‰©:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Debug APK" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "- âœ… Release APK (å·²ç­¾åï¼Œ3ä¸ªæž¶æž„)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ å¦‚ä½•ä¸‹è½½:**" >> $GITHUB_STEP_SUMMARY
          echo "1. æ»šåŠ¨åˆ°æœ¬é¡µé¢åº•éƒ¨" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰¾åˆ° \`Artifacts\` åŒºåŸŸ" >> $GITHUB_STEP_SUMMARY
          echo "3. ç‚¹å‡»å¯¹åº”çš„ APK åŒ…ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "4. è§£åŽ‹ \`.zip\` æ–‡ä»¶èŽ·å– APK" >> $GITHUB_STEP_SUMMARY
