name: [DISABLED] Test Multi-Architecture Build (Legacy Flutter Workflow)

on:
  workflow_dispatch:
    inputs:
      test_architecture:
        description: 'Select architecture to test'
        required: true
        default: 'arm64'
        type: choice
        options:
        - arm32
        - arm64
        - x64
        - universal
        - all

env:
  FLUTTER_VERSION: '3.29.3'
  JAVA_VERSION: '17'

jobs:
  test-single-arch:
    name: Test Single Architecture Build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_architecture != 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate version number
        id: version
        run: |
          ./.github/scripts/version-generator.sh

      - name: Update version in pubspec.yaml
        run: |
          sed -i "s/^version: .*/version: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.build-number }}/" pubspec.yaml
          grep "^version:" pubspec.yaml

      - name: Test Build (${{ github.event.inputs.test_architecture }})
        run: |
          ARCH="${{ github.event.inputs.test_architecture }}"
          echo "ğŸ§ª æµ‹è¯•æ„å»º ${ARCH} æ¶æ„..."
          
          case "${ARCH}" in
            "arm32")
              echo "ğŸ“± æ„å»ºARM32ç‰ˆæœ¬"
              flutter build apk --debug --target-platform=android-arm --build-number=${{ steps.version.outputs.build-number }}
              ;;
            "arm64")
              echo "ğŸ“± æ„å»ºARM64ç‰ˆæœ¬"
              flutter build apk --debug --target-platform=android-arm64 --build-number=${{ steps.version.outputs.build-number }}
              ;;
            "x64")
              echo "ğŸ’» æ„å»ºx64ç‰ˆæœ¬"
              flutter build apk --debug --target-platform=android-x64 --build-number=${{ steps.version.outputs.build-number }}
              ;;
            "universal")
              echo "ğŸŒ æ„å»ºé€šç”¨ç‰ˆæœ¬"
              flutter build apk --debug --build-number=${{ steps.version.outputs.build-number }}
              ;;
          esac
          
          echo "âœ… æ„å»ºå®Œæˆï¼"
          echo "ğŸ“Š APKä¿¡æ¯ï¼š"
          ls -la build/app/outputs/flutter-apk/
          du -h build/app/outputs/flutter-apk/app-debug.apk

  test-all-arch:
    name: Test All Architectures Build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_architecture == 'all'
    strategy:
      matrix:
        include:
          - arch: "arm32"
            target-platform: "android-arm"
            abi: "armeabi-v7a"
          - arch: "arm64"
            target-platform: "android-arm64"
            abi: "arm64-v8a"
          - arch: "x64"
            target-platform: "android-x64"
            abi: "x86_64"
          - arch: "universal"
            target-platform: ""
            abi: "all"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate version number
        id: version
        run: |
          ./.github/scripts/version-generator.sh

      - name: Update version in pubspec.yaml
        run: |
          sed -i "s/^version: .*/version: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.build-number }}/" pubspec.yaml

      - name: Test Build (${{ matrix.arch }})
        run: |
          echo "ğŸ§ª æµ‹è¯•æ„å»º ${{ matrix.arch }} æ¶æ„ (${{ matrix.abi }})..."
          
          if [ "${{ matrix.arch }}" = "universal" ]; then
            echo "ğŸŒ æ„å»ºé€šç”¨ç‰ˆæœ¬ï¼ˆåŒ…å«æ‰€æœ‰æ¶æ„ï¼‰"
            flutter build apk --debug --build-number=${{ steps.version.outputs.build-number }}
          else
            echo "ğŸ¯ æ„å»º ${{ matrix.arch }} ç‰¹å®šæ¶æ„"
            flutter build apk --debug \
              --target-platform=${{ matrix.target-platform }} \
              --build-number=${{ steps.version.outputs.build-number }}
          fi
          
          # é‡å‘½åAPKä»¥ä¾¿åŒºåˆ†
          APK_NAME="app-debug-${{ matrix.arch }}.apk"
          mv build/app/outputs/flutter-apk/app-debug.apk "build/app/outputs/flutter-apk/${APK_NAME}"
          
          echo "âœ… ${{ matrix.arch }} æ„å»ºå®Œæˆï¼"
          echo "ğŸ“Š APKä¿¡æ¯ï¼š"
          echo "æ–‡ä»¶å: ${APK_NAME}"
          echo "å¤§å°: $(du -h build/app/outputs/flutter-apk/${APK_NAME} | cut -f1)"
          echo "æ¶æ„: ${{ matrix.abi }}"

      - name: Upload test APK
        uses: actions/upload-artifact@v4
        with:
          name: test-apk-${{ matrix.arch }}
          path: build/app/outputs/flutter-apk/app-debug-${{ matrix.arch }}.apk
          retention-days: 7

  summary:
    name: Build Test Summary
    runs-on: ubuntu-latest
    needs: [test-single-arch, test-all-arch]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "ğŸ‰ å¤šæ¶æ„æ„å»ºæµ‹è¯•å®Œæˆï¼"
          echo ""
          echo "ğŸ“Š æµ‹è¯•ç»“æœï¼š"
          
          if [ "${{ github.event.inputs.test_architecture }}" = "all" ]; then
            echo "âœ… æµ‹è¯•äº†æ‰€æœ‰4ç§æ¶æ„ï¼šARM32, ARM64, x64, Universal"
            echo "ğŸ“¦ ç”Ÿæˆçš„APKå¯åœ¨Artifactsä¸­ä¸‹è½½æŸ¥çœ‹ä½“ç§¯å·®å¼‚"
          else
            echo "âœ… æµ‹è¯•äº† ${{ github.event.inputs.test_architecture }} æ¶æ„"
          fi
          
          echo ""
          echo "ğŸ’¡ æç¤ºï¼š"
          echo "- ARM64ç‰ˆæœ¬é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£Androidè®¾å¤‡"
          echo "- ARM32ç‰ˆæœ¬é€‚ç”¨äºè¾ƒè€çš„32ä½è®¾å¤‡"
          echo "- x64ç‰ˆæœ¬é€‚ç”¨äºæ¨¡æ‹Ÿå™¨å’Œx86æ¶æ„è®¾å¤‡"
          echo "- Universalç‰ˆæœ¬å…¼å®¹æ‰€æœ‰æ¶æ„ä½†ä½“ç§¯æœ€å¤§"