# Lumi Assistant - 项目开发计划

## 项目概述
基于Flutter开发的智能语音助手客户端，采用渐进式开发方式，确保每个功能都经过充分验证。

### 技术栈
- **框架**: Flutter 3.16+
- **状态管理**: flutter_hooks + hooks_riverpod  
- **网络通信**: dio + web_socket_channel
- **架构模式**: 分层架构 + 声明式状态管理 + 组合式组件设计

### 后端服务
- **WebSocket**: ws://192.168.110.199:8000/
- **HTTP API**: http://192.168.110.199:8000/api
- **认证方式**: Bearer Token + Device-ID

**注意**：`192.168.110.199:8000` 是开发环境的IP地址，生产环境部署时需要调整为实际的服务器地址。

## 开发原则
1. **渐进式开发**: 每个里程碑独立完成和验证
2. **质量优先**: 先确保功能稳定再添加新特性  
3. **用户验证**: 每个里程碑都需要用户确认通过
4. **文档同步**: 开发过程和决策都要记录

## 第一阶段目标：文字聊天全流程打通

### 里程碑规划

#### 🎯 里程碑1：项目基础搭建
**预计时间**: 0.5天  
**开发内容**:
- 创建Flutter项目
- 配置基础依赖  
- 搭建项目目录结构
- 实现基础主题和样式

**验证标准**:
- [x] 项目能成功编译并运行
- [x] 显示一个简单的"Hello World"界面  
- [x] 热重载功能正常
- [x] 无编译错误和警告

---

#### 🎯 里程碑2：网络连接基础  
**预计时间**: 1天
**开发内容**:
- 实现WebSocket连接服务
- 添加连接状态显示
- 实现基础错误处理

**验证标准**:
- [ ] 能连接到后端WebSocket服务器
- [ ] 界面显示连接状态（已连接/未连接）
- [ ] 连接失败时显示错误信息
- [ ] 能发送Hello消息并收到响应

---

#### 🎯 里程碑3：Hello握手流程
**预计时间**: 0.5天
**开发内容**:
- 实现Hello消息发送
- 解析Hello响应  
- 保存session_id

**验证标准**:
- [ ] 连接成功后自动发送Hello消息
- [ ] 能正确解析服务器返回的Hello响应
- [ ] session_id被正确保存和显示
- [ ] 握手失败时显示具体错误

---

#### 🎯 里程碑4：基础UI框架
**预计时间**: 1天  
**开发内容**:
- 主界面布局
- 背景图片显示
- 基础信息面板（时间显示）
- 右下角按钮

**验证标准**:
- [ ] 界面布局正确，符合设计要求
- [ ] 背景图片正常显示
- [ ] 时间显示准确并实时更新  
- [ ] 右下角按钮位置和样式正确
- [ ] 在不同屏幕尺寸下显示正常

---

#### 🎯 里程碑5：聊天界面基础
**预计时间**: 1天
**开发内容**:
- 聊天弹窗组件
- 消息输入框
- 发送按钮
- 基础消息显示

**验证标准**:
- [ ] 点击右下角按钮能弹出聊天界面
- [ ] 输入框能正常输入文字
- [ ] 发送按钮响应点击事件
- [ ] 能在界面显示输入的消息
- [ ] 聊天界面能正常关闭

---

#### 🎯 里程碑6：文字消息发送
**预计时间**: 1天
**开发内容**:
- 实现chat消息发送
- 消息状态管理（发送中/已发送/失败）
- 发送失败重试机制

**验证标准**:
- [ ] 输入文字点击发送后，消息显示为"发送中"状态
- [ ] 消息成功发送后状态变为"已发送"
- [ ] 发送失败时显示"发送失败"并提供重试
- [ ] 网络异常时重试机制正常工作

---

#### 🎯 里程碑7：LLM响应处理
**预计时间**: 1天
**开发内容**:
- 接收并解析LLM响应消息
- 在聊天界面显示AI回复
- 处理流式响应（如果支持）

**验证标准**:
- [ ] 发送消息后能收到AI的回复
- [ ] AI回复正确显示在聊天界面
- [ ] 消息气泡样式区分用户和AI
- [ ] 长回复内容显示完整
- [ ] 响应时间合理

---

#### 🎯 里程碑8：错误处理完善
**预计时间**: 1天
**开发内容**:
- 完善各种错误场景处理
- 用户友好的错误提示
- 自动重连机制
- 离线状态处理

**验证标准**:
- [ ] 网络断开时显示合适的提示信息
- [ ] 服务器错误时显示具体错误原因
- [ ] 自动重连功能正常工作
- [ ] 离线状态下的用户体验良好

---

#### 🎯 里程碑9：本地存储和历史记录
**预计时间**: 1天
**开发内容**:
- 聊天记录本地存储
- 历史消息加载
- 存储清理机制

**验证标准**:
- [ ] 聊天记录能正确保存到本地
- [ ] 重启应用后历史记录正常加载
- [ ] 历史记录显示正确的时间顺序
- [ ] 存储空间使用合理

---

#### 🎯 里程碑10：性能优化和打包
**预计时间**: 1天
**开发内容**:
- 性能优化
- 内存泄漏检查
- 打包配置
- 最终测试

**验证标准**:
- [ ] 应用启动时间 < 3秒
- [ ] 内存使用稳定，无明显泄漏
- [ ] 长时间使用无卡顿现象
- [ ] APK大小合理
- [ ] 能正常安装和运行

## 验证流程规范

### 每个里程碑的验证流程
1. **开发完成** → 2. **自测验证** → 3. **提交验证** → 4. **用户确认** → 5. **进入下一里程碑**

### 自测验证检查清单
- [ ] 代码编译无错误无警告
- [ ] 核心功能按预期工作
- [ ] 界面显示正常
- [ ] 无明显性能问题
- [ ] 错误场景处理正确

### 用户验证检查清单
- [ ] 功能符合需求预期
- [ ] 用户体验流畅
- [ ] 无阻塞性问题
- [ ] 可以进入下一阶段开发

## 🎉 第一阶段完成状态

### 总结
第一阶段（文本聊天功能）已全部完成，包含里程碑1-8：
- ✅ 项目基础搭建
- ✅ 网络连接基础
- ✅ Hello握手流程
- ✅ 基础UI框架
- ✅ 聊天界面基础
- ✅ 文字消息发送
- ✅ LLM响应处理
- ✅ 错误处理完善

**第一阶段特点**：
- 完整的文本聊天功能
- 稳定的WebSocket连接
- 完善的错误处理机制
- 友好的用户界面
- 支持多设备尺寸

---

## 🎯 第二阶段目标：语音交互功能

### 技术架构设计

#### 音频处理架构
- **编解码器**: Opus（16kHz, 单声道, 60ms帧）
- **采样率**: 16kHz
- **声道数**: 单声道
- **帧时长**: 60ms
- **比特率**: 自适应（8-64 kbps）

#### 处理流程
```
用户语音 → 麦克风 → PCM16 → Opus编码 → WebSocket二进制流 → 服务器
服务器 → Opus音频 → WebSocket二进制流 → Opus解码 → PCM → 扬声器
```

### 里程碑规划

#### 🎯 里程碑11：音频权限和基础设施
**预计时间**: 1天
**开发内容**:
- 录音权限管理
- 音频会话配置
- 音频状态监控
- 权限请求UI

**验证标准**:
- [ ] 录音权限请求流程正确
- [ ] 权限被拒绝时显示指导提示
- [ ] 音频会话正确配置
- [ ] 能检测麦克风和扬声器状态

---

#### 🎯 里程碑12：音频录制和编码
**预计时间**: 2天
**开发内容**:
- 集成flutter_sound或record库
- 实现Opus编码（通过opus_dart）
- 音频数据缓冲管理
- 录制状态管理

**验证标准**:
- [ ] 能正常录制音频
- [ ] 音频格式为PCM16, 16kHz, 单声道
- [ ] Opus编码正确实现
- [ ] 录制开始/停止状态正确

---

#### 🎯 里程碑13：实时音频流传输
**预计时间**: 1.5天
**开发内容**:
- WebSocket二进制消息发送
- 音频流分帧处理
- 实时传输优化
- 网络异常处理

**验证标准**:
- [ ] 音频数据能通过WebSocket发送
- [ ] 60ms帧间隔正确保持
- [ ] 网络延迟下音频传输稳定
- [ ] 传输错误能正确重试

---

#### 🎯 里程碑14：语音界面和交互
**预计时间**: 1.5天
**开发内容**:
- 语音输入按钮设计
- 录制状态可视化
- 语音波形动画
- 按住说话/点击切换模式

**验证标准**:
- [ ] 语音按钮交互流畅
- [ ] 录制状态清晰可见
- [ ] 语音波形动画自然
- [ ] 支持按住说话和点击切换

---

#### 🎯 里程碑15：TTS音频接收和播放
**预计时间**: 2天
**开发内容**:
- WebSocket二进制数据接收
- Opus解码实现
- 音频播放管理
- 播放状态同步

**验证标准**:
- [ ] 能接收服务器的Opus音频数据
- [ ] Opus解码正确实现
- [ ] 音频播放清晰无杂音
- [ ] 播放状态与聊天状态同步

---

#### 🎯 里程碑16：语音消息管理
**预计时间**: 1天
**开发内容**:
- 语音消息UI组件
- 播放控制按钮
- 语音消息存储
- 历史语音回放

**验证标准**:
- [ ] 语音消息在聊天界面正确显示
- [ ] 播放控制按钮功能正常
- [ ] 语音消息能正确存储和加载
- [ ] 历史语音能正常回放

---

#### 🎯 里程碑17：语音交互优化
**预计时间**: 1天
**开发内容**:
- 语音检测优化（VAD）
- 噪声抑制
- 回声消除
- 性能优化

**验证标准**:
- [ ] 语音检测准确性高
- [ ] 环境噪声得到有效抑制
- [ ] 无回声问题
- [ ] 音频处理性能稳定

---

#### 🎯 里程碑18：语音功能集成测试
**预计时间**: 1天
**开发内容**:
- 端到端测试
- 性能压力测试
- 用户体验优化
- 错误场景处理

**验证标准**:
- [ ] 完整的语音对话流程正常
- [ ] 长时间使用无性能问题
- [ ] 各种错误场景处理正确
- [ ] 用户体验流畅自然

### 技术依赖和集成

#### 主要Flutter包
```yaml
dependencies:
  # 音频录制和播放
  flutter_sound: ^9.2.13
  # 或者
  record: ^4.4.4
  audioplayers: ^5.0.0
  
  # Opus编解码
  opus_dart: ^1.0.0
  
  # 权限管理
  permission_handler: ^10.4.3
  
  # 音频处理
  flutter_audio_capture: ^0.0.2
```

#### 平台配置
**Android**:
```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
```

**iOS**:
```xml
<key>NSMicrophoneUsageDescription</key>
<string>需要录音权限来实现语音交互</string>
```

### 与第一阶段的集成

#### 状态管理扩展
- 扩展ChatState支持语音状态
- 增加AudioState管理音频状态
- 集成语音消息到现有消息流

#### WebSocket协议扩展
- 支持二进制消息传输
- 扩展消息类型（audio_start, audio_data, audio_end）
- 保持与现有text消息兼容

#### UI/UX集成
- 语音按钮集成到ChatInputBar
- 语音消息气泡设计
- 语音状态指示器
- 与现有错误处理机制集成

### 风险评估和应对

#### 技术风险
1. **Opus编解码性能**: 在低端设备上可能有性能问题
   - 应对：提供音质档位选择
2. **实时音频传输**: 网络波动可能影响音频质量
   - 应对：自适应比特率和缓冲管理
3. **平台兼容性**: Android和iOS音频API差异
   - 应对：封装统一的音频接口

#### 开发风险
1. **第三方库依赖**: flutter_sound等库可能有兼容性问题
   - 应对：准备备选方案（record + audioplayers）
2. **权限管理**: 用户拒绝权限影响功能
   - 应对：优雅的权限引导流程

### 成功标准
- 完整的语音输入输出功能
- 语音质量清晰，延迟低于500ms
- 支持连续对话，无需重复按钮
- 与现有文本功能无缝集成
- 在主流Android设备上稳定运行

---

## 🔄 第三阶段：图像分析功能

### 里程碑预览
- 里程碑19：相机权限和基础集成
- 里程碑20：图片选择和处理
- 里程碑21：图像上传和分析
- 里程碑22：结果展示和交互

---

## 🎭 第四阶段：Live2D动画集成

### 里程碑预览  
- 里程碑23：Live2D模型加载
- 里程碑24：情感状态映射
- 里程碑25：动画性能优化
- 里程碑26：最终集成和发布

---

## 开发记录
- **创建时间**: 2025-07-08
- **第一阶段完成**: 2025-07-11
- **当前阶段**: 第二阶段语音交互功能规划
- **下一步**: 开始里程碑11 - 音频权限和基础设施